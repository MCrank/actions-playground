# This is a basic workflow to help you get started with Actions

name: CI

env: 
  DOCKERHUB_REPO: mcrank/twix

on:
  push:
    branches: [ 'main' ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.docker_meta.outputs.tags }}
    
    steps:
      - uses: actions/checkout@v3

      - name: Github Tag Bump
        if: github.ref == 'refs/heads/main'
        id: tag_bump
        uses: anothrNick/github-tag-action@1.36.0
        env:
          GITHUB_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
          WITH_V: 'true'
          DEFAULT_BUMP: major
          DRY_RUN: true
      
      - name: Push new Major Version
        if: github.ref == 'refs/heads/main'
        env:
          NEW_TAG: ${{ steps.tag_bump.outputs.new_tag }}
        run: |
          export MAJOR_MINOR=${NEW_TAG%.*}
          export MAJOR=${MAJOR_MINOR%.*}
          git tag --force "${MAJOR}"
          git push --tags --force

      - name: Generate Docker Tags
        if: startsWith(github.ref, 'refs/tags/v')
        id: docker_meta
        uses: docker/metadata-action@v3
        with:
          images: ${{ env.DOCKERHUB_REPO }}
          tags: |
            type=semver,pattern=v{{major}},priority=40
            type=semver,pattern=v{{major}},suffix=-{{date ''}},priority=30
            type=sha,priority=20
  debug:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Output tags
        env:
          TWIX_TAGS: ${{ needs.build.outputs.tags }}
        run: |
          echo $TWIX_TAGS[0]

